<?php
/** @var \Josequal\ImportExport\Block\Adminhtml\Log\Index $block */
?>
<div class="josequal-import-export">
    <div class="page-main-actions">
        <div class="page-actions">
            <button type="button" class="action-primary" onclick="refreshLog()">
                <span><?= $block->escapeHtml(__('Refresh Log')) ?></span>
            </button>
            <button type="button" class="action-secondary" onclick="clearLog()">
                <span><?= $block->escapeHtml(__('Clear Log')) ?></span>
            </button>
        </div>
    </div>

    <!-- Log Table -->
    <div class="import-export-form">
        <h2><?= $block->escapeHtml(__('Import/Export Log')) ?></h2>

        <div class="log-filters">
            <div class="form-group">
                <label for="filter_operation"><?= $block->escapeHtml(__('Operation Type')) ?></label>
                <select id="filter_operation" onchange="filterLog()">
                    <option value=""><?= $block->escapeHtml(__('All Operations')) ?></option>
                    <option value="import"><?= $block->escapeHtml(__('Import')) ?></option>
                    <option value="export"><?= $block->escapeHtml(__('Export')) ?></option>
                </select>
            </div>

            <div class="form-group">
                <label for="filter_entity"><?= $block->escapeHtml(__('Entity Type')) ?></label>
                <select id="filter_entity" onchange="filterLog()">
                    <option value=""><?= $block->escapeHtml(__('All Entities')) ?></option>
                    <option value="product"><?= $block->escapeHtml(__('Products')) ?></option>
                    <option value="category"><?= $block->escapeHtml(__('Categories')) ?></option>
                </select>
            </div>

            <div class="form-group">
                <label for="filter_status"><?= $block->escapeHtml(__('Status')) ?></label>
                <select id="filter_status" onchange="filterLog()">
                    <option value=""><?= $block->escapeHtml(__('All Statuses')) ?></option>
                    <option value="1"><?= $block->escapeHtml(__('Running')) ?></option>
                    <option value="2"><?= $block->escapeHtml(__('Completed')) ?></option>
                    <option value="3"><?= $block->escapeHtml(__('Failed')) ?></option>
                </select>
            </div>
        </div>

        <div class="log-table-container">
            <table class="data-grid" id="log-table">
                <thead>
                    <tr>
                        <th><?= $block->escapeHtml(__('ID')) ?></th>
                        <th><?= $block->escapeHtml(__('Operation')) ?></th>
                        <th><?= $block->escapeHtml(__('Entity Type')) ?></th>
                        <th><?= $block->escapeHtml(__('File Name')) ?></th>
                        <th><?= $block->escapeHtml(__('Total Records')) ?></th>
                        <th><?= $block->escapeHtml(__('Successful')) ?></th>
                        <th><?= $block->escapeHtml(__('Failed')) ?></th>
                        <th><?= $block->escapeHtml(__('Status')) ?></th>
                        <th><?= $block->escapeHtml(__('Started At')) ?></th>
                        <th><?= $block->escapeHtml(__('Completed At')) ?></th>
                        <th><?= $block->escapeHtml(__('Actions')) ?></th>
                    </tr>
                </thead>
                <tbody id="log-table-body">
                    <!-- Log data will be loaded here -->
                </tbody>
            </table>
        </div>

        <div class="log-pagination">
            <button type="button" class="action-secondary" onclick="previousPage()" id="prev-btn" disabled>
                <?= $block->escapeHtml(__('Previous')) ?>
            </button>
            <span id="page-info"><?= $block->escapeHtml(__('Page 1 of 1')) ?></span>
            <button type="button" class="action-secondary" onclick="nextPage()" id="next-btn" disabled>
                <?= $block->escapeHtml(__('Next')) ?>
            </button>
        </div>
    </div>
</div>

<script>
var currentPage = 1;
var totalPages = 1;
var logData = [];

function refreshLog() {
    // Simulate loading log data
    loadLogData();
}

function loadLogData() {
    // Here you would typically make an AJAX call to load log data
    // For now, we'll use sample data
    logData = [
        {
            entity_id: 1,
            operation_type: 'import',
            entity_type: 'product',
            file_name: 'products_import.csv',
            total_records: 150,
            successful_records: 145,
            failed_records: 5,
            status: 2,
            started_at: '2024-01-15 10:30:00',
            completed_at: '2024-01-15 10:35:00'
        },
        {
            entity_id: 2,
            operation_type: 'export',
            entity_type: 'category',
            file_name: 'categories_export.csv',
            total_records: 50,
            successful_records: 50,
            failed_records: 0,
            status: 2,
            started_at: '2024-01-15 11:00:00',
            completed_at: '2024-01-15 11:02:00'
        }
    ];

    renderLogTable();
}

function renderLogTable() {
    var tbody = document.getElementById('log-table-body');
    tbody.innerHTML = '';

    logData.forEach(function(log) {
        var row = document.createElement('tr');
        row.innerHTML = `
            <td>${log.entity_id}</td>
            <td><span class="status-indicator ${getStatusClass(log.operation_type)}"></span>${log.operation_type}</td>
            <td>${log.entity_type}</td>
            <td>${log.file_name}</td>
            <td>${log.total_records}</td>
            <td>${log.successful_records}</td>
            <td>${log.failed_records}</td>
            <td><span class="status-indicator ${getStatusClass(log.status)}"></span>${getStatusText(log.status)}</td>
            <td>${log.started_at}</td>
            <td>${log.completed_at || '-'}</td>
            <td>
                <button type="button" class="action-secondary" onclick="viewDetails(${log.entity_id})">
                    ${log.operation_type === 'import' ? 'View Errors' : 'Download'}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function getStatusClass(status) {
    if (typeof status === 'string') {
        return status === 'import' ? 'running' : 'success';
    } else {
        switch(status) {
            case 1: return 'running';
            case 2: return 'success';
            case 3: return 'error';
            default: return 'warning';
        }
    }
}

function getStatusText(status) {
    switch(status) {
        case 1: return 'Running';
        case 2: return 'Completed';
        case 3: return 'Failed';
        default: return 'Unknown';
    }
}

function filterLog() {
    // Implement filtering logic here
    refreshLog();
}

function viewDetails(entityId) {
    // Implement view details logic here
    alert('View details for log ID: ' + entityId);
}

function clearLog() {
    if (confirm('Are you sure you want to clear the log?')) {
        // Implement clear log logic here
        refreshLog();
    }
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
        updatePagination();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        updatePagination();
    }
}

function updatePagination() {
    document.getElementById('prev-btn').disabled = currentPage === 1;
    document.getElementById('next-btn').disabled = currentPage === totalPages;
    document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
}

// Load log data when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadLogData();
});
</script>
